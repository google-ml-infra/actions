# Copyright 2025 Google LLC

# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at

#     https://www.apache.org/licenses/LICENSE-2.0

# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
name: "Check clang-format"
description: 'Action to run clang-format on changed files'
inputs:
  clang_format_version:
    description: 'The clang-format version to use.'
    required: true
    default: "20.1.5"

runs:
  using: "composite"
  steps:
  - name: "Checking out repository"
    uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
    with:
      fetch-depth: 0 # Fetch full history for accurate diffing
  - name: Run clang-format check
    id: check-format
    shell: bash
    env:
      REPO_CLANG_FORMAT: .clang-format
      ACTION_DEFAULT_CLANG_FORMAT: ${{ github.action_path }}.clang-format.default
      CLANG_FORMAT_VERSION: ${{ inputs.clang_format_version }}
      TARGET_BRANCH: ${{ github.base_ref }}
    run: |
      FILE_PATTERNS="*.cc *.h"
      CLANG_FORMAT_COMMON_ARGS="--dry-run --Werror --verbose"

      # Add this line to resolve the dubious ownership error
      git config --global --add safe.directory "$GITHUB_WORKSPACE"

      # Compare PR head against the base branch to find changed files.
      GIT_DIFF_CMD="git diff -z --name-only --diff-filter=d origin/$TARGET_BRANCH HEAD -- $FILE_PATTERNS"

      if [ -f "$REPO_CLANG_FORMAT" ]; then
        echo "::notice::Using repository's .clang-format file."
        # uvx (an alias for `uv tool run`) installs and runs clang-format with a specific version.
        $GIT_DIFF_CMD | xargs -0 uvx clang-format==$CLANG_FORMAT_VERSION $CLANG_FORMAT_COMMON_ARGS
      else
        echo "::notice::Repository does not have a .clang-format file. Using the action's default under $ACTION_DEFAULT_CLANG_FORMAT."
        $GIT_DIFF_CMD | xargs -0 uvx clang-format==$CLANG_FORMAT_VERSION -style=file:$ACTION_DEFAULT_CLANG_FORMAT $CLANG_FORMAT_COMMON_ARGS
      fi

# Copyright 2024 Google LLC

# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at

#     https://www.apache.org/licenses/LICENSE-2.0

# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
name: "Wait For Connection"
description: 'Action to wait for connection from user (conditionally)'
inputs:
  halt-dispatch-input:
    description: 'Should the action wait for user connection from workflow_dispatch?'
    required: false
    default: "no"
outputs:
  halt-trap-script:
    description: "Location of the halt script to run on failure in combination with trap"
    value: ${{ steps.wait_for_connection.outputs.halt-trap-script }}
runs:
  using: "composite"
  steps:
  - name: Wait for connection (conditionally)
    id: wait-for-connection
    shell: bash
    env:
      PYTHONUNBUFFERED: 1
      HALT_DISPATCH_INPUT: ${{ inputs.halt-dispatch-input }}
    # The calling workflow shouldn't fail in case this step does
    continue-on-error: true
    run: |
      # Pick an existing Python alias
      python_bin=$(which python3 2>/dev/null || which python)
      # Wait for the connection, if a halt was requested via a label/input
      "$python_bin" "$GITHUB_ACTION_PATH/wait_for_connection.py"
      echo "halt-trap-script=$GITHUB_ACTION_PATH/wait_for_connection.py" >> $GITHUB_OUTPUT
